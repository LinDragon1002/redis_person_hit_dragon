<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龍王 vs 勇者 - 戰鬥指揮中心</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚔️</text></svg>">
    
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    
    <canvas id="particleCanvas" style="position: fixed; top: 0; left: 0; z-index: -1;"></canvas>
    
    <nav class="tech-navbar">
        <div class="container navbar-content">
            <div class="navbar-left">
                <div class="logo-container">
                    <i class="fas fa-dragon"></i>
                    <span class="brand-text">BATTLE ARENA</span>
                </div>
                <div class="system-status">
                    <span class="status-dot online"></span>
                    <span class="status-text">系統運行中</span>
                </div>
            </div>
            <ul class="navbar-links">
                <li><a href="#" class="active"><i class="fas fa-chart-line"></i> 戰情中心</a></li>
                <li><a href="/leaderboard"><i class="fas fa-trophy"></i> 排行榜</a></li>
                <li><a href="#achievements-section"><i class="fas fa-medal"></i> 成就</a></li>
                <li><a href="/history"><i class="fas fa-history"></i> 全部紀錄</a></li>
            </ul>
            <div class="navbar-right" style="display: flex; align-items: center; gap: 15px;">
                <button class="help-btn" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    <span>玩法說明</span>
                </button>
                <div class="sound-toggle" style="cursor: pointer;">
                    <i class="fas fa-volume-up" id="soundIcon"></i>
                </div>
            </div>
        </div>
    </nav>

    <div id="realtimeNotifications" class="realtime-notifications"></div>

    <div class="container main-content">
        <header class="tech-header">
            <div class="header-content">
                <div class="title-container">
                    <h1 class="glitch-text" data-text="戰鬥指揮中心">戰鬥指揮中心</h1>
                    <div class="subtitle-tech">
                        <span class="typing-text">實時監控系統 v2.0</span>
                    </div>
                </div>
                
                <!-- 難度選擇 - 預設普通模式 -->
                <div class="difficulty-selector">
                    <button class="difficulty-btn easy" data-difficulty="easy">簡單</button>
                    <button class="difficulty-btn normal active" data-difficulty="normal">普通</button>
                    <button class="difficulty-btn hard" data-difficulty="hard">困難</button>
                </div>
                
                <div class="control-panel">
                    <button id="runGameBtn" class="tech-btn primary" onclick="startWebGameBackend(false)">
                        <i class="fas fa-bolt"></i>
                        <span>啟動決鬥</span>
                    </button>
                    <button id="autoBattleBtn" class="tech-btn auto" onclick="startWebGameBackend(true)">
                        <i class="fas fa-robot"></i>
                        <span>自動模式</span>
                    </button>
                </div>
                
                <div id="gameStatus" class="game-status-tech"></div>
                
                <!-- 網頁版戰鬥區域 -->
                <div id="gameContainer" class="hidden">
                    <h2 style="text-align: center; color: var(--neon-cyan); font-family: var(--font-tech);">龍王 VS 勇者</h2>
                    <div id="webBattleArea">
                        <img id="dragonSprite" src="../static/images/dragon_girl.png" class="character-sprite" style="right: 50px; top: 100px;">
                        <img id="personSprite" src="../static/images/person_boy.png" class="character-sprite" style="left: 50px; top: 100px; transform: scaleX(-1);">
                        
                        <!-- HP 顯示 -->
                        <div class="hp-container" style="position: absolute; top: 15px; right: 20px;">
                            <div style="color: #888; font-size: 0.9em;">龍王 HP</div>
                            <div class="hp-value dragon" id="dragonHp">20</div>
                        </div>
                        <div class="hp-container" style="position: absolute; top: 15px; left: 20px;">
                            <div style="color: #888; font-size: 0.9em;">勇者 HP</div>
                            <div class="hp-value person" id="personHp">20</div>
                        </div>
                        
                        <div id="battleStatus" style="position: absolute; width: 100%; top: 50%; text-align: center; font-size: 2em; text-shadow: 0 0 10px black; pointer-events: none;"></div>
                    </div>

                    <!--技能按鈕 - 顯示 CD 狀態-->
                    <div class="control-panel" id="skillPanel">
                        <button class="skill-btn-cyber ready" data-skill="1" onclick="sendAction(1)">
                            普攻 (1)
                            <span class="cd-indicator"></span>
                        </button>
                        <button class="skill-btn-cyber ready" data-skill="2" onclick="sendAction(2)">
                            治療 (2)
                            <span class="cd-indicator"></span>
                        </button>
                        <button class="skill-btn-cyber on-cooldown" data-skill="3" onclick="sendAction(3)">
                            大絕 (3)
                            <span class="cd-indicator">2T</span>
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px; color: #aaa;">
                        <span id="connectionStatus">等待連接...</span>
                    </div>
                </div>
                
                <div id="pygameMessage" class="hidden" style="text-align: center; margin-top: 50px; padding: 30px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <h2><i class="fas fa-desktop"></i> 遊戲已在伺服器端視窗啟動</h2>
                    <p style="color: var(--text-secondary);">請查看伺服器/本機的 Pygame 視窗進行遊玩。</p>
                </div>
            </div>
        </header>

        <!--核心數據儀表板-->
        <div class="dashboard-grid">
            <div class="dash-card stats-panel">
                <div class="card-header">
                    <h3><i class="fas fa-database"></i> 核心數據(全部人)</h3>
                </div>
                <div class="stats-display">
                    <div class="stat-item">
                        <!-- ★ 修改：使用更清楚的圖示 -->
                        <div class="stat-icon games" style="background: linear-gradient(135deg, rgba(0, 255, 255, 0.22), rgba(0,255,255,0.1)); border: 2px solid var(--neon-cyan); color: var(--neon-cyan); border-radius: 12px;">
                            <i class="fas fa-gamepad" style="font-size: 24px;"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">總戰鬥場次</div>
                            <div class="stat-value" id="totalGames" style="font-family: 'Orbitron', monospace; color: var(--neon-cyan);">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-icon rounds" style="background: linear-gradient(135deg, rgba(255,0,255,0.2), rgba(255,0,255,0.1)); border: 2px solid var(--neon-pink); color: var(--neon-pink); border-radius: 12px;">
                            <i class="fas fa-sync-alt" style="font-size: 24px;"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">平均回合數</div>
                            <div class="stat-value" id="avgRounds" style="font-family: 'Orbitron', monospace; color: var(--neon-pink);">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dash-card chart-panel">
                <div class="card-header">
                    <h3><i class="fas fa-chart-pie"></i> 勝率分析</h3>
                </div>
                <div class="chart-container-tech" style="position: relative; height: 200px;">
                    <canvas id="winRateChart"></canvas>
                    <div class="chart-center-info" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div class="center-label" style="color: #888; font-size: 0.8em;">總場次</div>
                        <div class="center-value" id="centerTotal" style="color: var(--neon-cyan); font-size: 1.8em; font-weight: bold; font-family: 'Orbitron', monospace;">0</div>
                    </div>
                </div>
                <div class="legend-tech" style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: var(--dragon-color); border-radius: 50%; box-shadow: 0 0 10px var(--dragon-color);"></div>
                        <span>龍王</span>
                        <strong id="dragonWinRate" style="font-family: 'Orbitron', monospace;">0%</strong>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: var(--person-color); border-radius: 50%; box-shadow: 0 0 10px var(--person-color);"></div>
                        <span>勇者</span>
                        <strong id="personWinRate" style="font-family: 'Orbitron', monospace;">0%</strong>
                    </div>
                </div>
            </div>
        </div>

        <!--戰士詳細資訊-->
        <div class="warriors-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
            <!-- 龍王 -->
            <div class="warrior-card dragon-side" style="background: linear-gradient(135deg, rgba(255, 51, 102, 0.1) 0%, rgba(20, 20, 40, 0.8) 100%); border: 2px solid var(--dragon-color); border-radius: 15px; padding: 25px;">
                <h3 style="color: var(--dragon-color); font-family: var(--font-tech); margin-bottom: 20px;"><i class="fas fa-dragon"></i> 龍王數據</h3>
                <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                    <img src="../static/images/dragon_girl.png" alt="龍王" style="width: 80px; border-radius: 10px; border: 2px solid var(--dragon-color); box-shadow: 0 0 15px rgba(255, 51, 102, 0.3);">
                    <div>
                        <div style="font-size: 0.9em; color: #888;">焰之支配者</div>
                        <div style="font-size: 1.5em; color: var(--dragon-color); font-family: 'Orbitron', monospace;"><i class="fas fa-crown"></i> <span id="dragonWins">0</span> 勝</div>
                    </div>
                </div>
                
                <!-- 科技風格數據條 -->
                <div class="warrior-stats">
                    <!-- 傷害 -->
                    <div class="stat-row-cyber">
                        <div class="stat-header-cyber">
                            <span class="stat-label-cyber damage"><i class="fas fa-fire-alt"></i> 總傷害</span>
                            <span class="avg-badge-cyber">AVG: <span id="dragonAvgDamage">0</span></span>
                        </div>
                        <div class="progress-container-cyber">
                            <div class="progress-bar-cyber">
                                <div id="dragonDamageBar" class="progress-fill-cyber damage" style="width: 0%;"></div>
                            </div>
                            <span class="stat-value-cyber damage" id="dragonTotalDamage">0</span>
                        </div>
                    </div>
                    
                    <!-- 治療 -->
                    <div class="stat-row-cyber">
                        <div class="stat-header-cyber">
                            <span class="stat-label-cyber heal"><i class="fas fa-heart"></i> 治療量</span>
                            <span class="avg-badge-cyber">AVG: <span id="dragonAvgHealing">0</span></span>
                        </div>
                        <div class="progress-container-cyber">
                            <div class="progress-bar-cyber">
                                <div id="dragonHealBar" class="progress-fill-cyber heal" style="width: 0%;"></div>
                            </div>
                            <span class="stat-value-cyber heal" id="dragonTotalHealing">0</span>
                        </div>
                    </div>
                    
                    <!-- 暴擊 -->
                    <div class="stat-row-cyber">
                        <div class="stat-header-cyber">
                            <span class="stat-label-cyber crit"><i class="fas fa-star"></i> 暴擊次數</span>
                        </div>
                        <div class="progress-container-cyber">
                            <div class="progress-bar-cyber">
                                <div id="dragonCritBar" class="progress-fill-cyber crit" style="width: 0%;"></div>
                            </div>
                            <span class="stat-value-cyber crit" id="dragonTotalCrits">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 勇者 -->
            <div class="warrior-card person-side" style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(20, 20, 40, 0.8) 100%); border: 2px solid var(--person-color); border-radius: 15px; padding: 25px;">
                <h3 style="color: var(--person-color); font-family: var(--font-tech); margin-bottom: 20px;"><i class="fas fa-user-ninja"></i> 勇者數據</h3>
                <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                    <img src="../static/images/person_boy.png" alt="勇者" style="width: 80px; border-radius: 10px; border: 2px solid var(--person-color); box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);">
                    <div>
                        <div style="font-size: 0.9em; color: #888;">光之使徒</div>
                        <div style="font-size: 1.5em; color: var(--person-color); font-family: 'Orbitron', monospace;"><i class="fas fa-crown"></i> <span id="personWins">0</span> 勝</div>
                    </div>
                </div>
                
                <div class="warrior-stats">
                    <div class="stat-row-cyber">
                        <div class="stat-header-cyber">
                            <span class="stat-label-cyber damage"><i class="fas fa-fire-alt"></i> 總傷害</span>
                            <span class="avg-badge-cyber">AVG: <span id="personAvgDamage">0</span></span>
                        </div>
                        <div class="progress-container-cyber">
                            <div class="progress-bar-cyber">
                                <div id="personDamageBar" class="progress-fill-cyber damage" style="width: 0%;"></div>
                            </div>
                            <span class="stat-value-cyber damage" id="personTotalDamage">0</span>
                        </div>
                    </div>
                    
                    <div class="stat-row-cyber">
                        <div class="stat-header-cyber">
                            <span class="stat-label-cyber heal"><i class="fas fa-heart"></i> 治療量</span>
                            <span class="avg-badge-cyber">AVG: <span id="personAvgHealing">0</span></span>
                        </div>
                        <div class="progress-container-cyber">
                            <div class="progress-bar-cyber">
                                <div id="personHealBar" class="progress-fill-cyber heal" style="width: 0%;"></div>
                            </div>
                            <span class="stat-value-cyber heal" id="personTotalHealing">0</span>
                        </div>
                    </div>
                    
                    <div class="stat-row-cyber">
                        <div class="stat-header-cyber">
                            <span class="stat-label-cyber crit"><i class="fas fa-star"></i> 暴擊次數</span>
                        </div>
                        <div class="progress-container-cyber">
                            <div class="progress-bar-cyber">
                                <div id="personCritBar" class="progress-fill-cyber crit" style="width: 0%;"></div>
                            </div>
                            <span class="stat-value-cyber crit" id="personTotalCrits">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--成就系統-->
        <div class="achievements-section" id="achievements-section" style="margin: 30px 0; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 15px; padding: 25px;">
            <div class="card-header">
                <h3 style="color: #ffd700;"><i class="fas fa-medal"></i> 解鎖成就</h3>
            </div>
            <div class="achievements-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                <div class="achievement-badge locked" id="achievement1">
                    <div class="badge-icon" style="font-size: 2em; margin-bottom: 10px;"><i class="fas fa-fire"></i></div>
                    <div class="badge-name" style="font-weight: bold;">首勝</div>
                    <div class="badge-desc" style="font-size: 0.8em; color: #888;">完成第一場戰鬥</div>
                </div>
                <div class="achievement-badge locked" id="achievement2">
                    <div class="badge-icon" style="font-size: 2em; margin-bottom: 10px;"><i class="fas fa-bolt"></i></div>
                    <div class="badge-name" style="font-weight: bold;">連勝王</div>
                    <div class="badge-desc" style="font-size: 0.8em; color: #888;">任一方獲勝 5 場</div>
                </div>
                <div class="achievement-badge locked" id="achievement3">
                    <div class="badge-icon" style="font-size: 2em; margin-bottom: 10px;"><i class="fas fa-trophy"></i></div>
                    <div class="badge-name" style="font-weight: bold;">百戰老將</div>
                    <div class="badge-desc" style="font-size: 0.8em; color: #888;">完成 100 場戰鬥</div>
                </div>
                <div class="achievement-badge locked" id="achievement4">
                    <div class="badge-icon" style="font-size: 2em; margin-bottom: 10px;"><i class="fas fa-star"></i></div>
                    <div class="badge-name" style="font-weight: bold;">暴擊大師</div>
                    <div class="badge-desc" style="font-size: 0.8em; color: #888;">累計 50 次暴擊</div>
                </div>
            </div>
        </div>

        <!-- 戰鬥歷史記錄 -->
        <div class="battle-history" style="margin: 30px 0; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.2); border-radius: 15px; padding: 25px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--neon-cyan);"><i class="fas fa-history"></i> 戰鬥履歷</h3>
                <div class="filter-buttons" style="display: flex; gap: 10px;">
                    <button class="filter-btn active" data-filter="all">全部</button>
                    <button class="filter-btn" data-filter="dragon">龍王勝</button>
                    <button class="filter-btn" data-filter="person">勇者勝</button>
                    <button class="filter-btn" data-filter="draw">平手</button>
                </div>
            </div>
            <div id="gamesList" class="battle-list">
                <div class="loading-tech">
                    <div class="loading-spinner"></div>
                    <span>載入戰鬥數據...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 玩家名稱輸入模態框 -->
    <div id="playerNameModal" class="modal-tech" style="display: flex;">
        <div class="modal-content-tech">
            <h2 style="color: var(--neon-cyan); font-family: var(--font-tech);"><i class="fas fa-dragon"></i> 戰鬥準備</h2>
            <div style="margin: 20px 0;">
                <input type="text" id="playerNameInput" placeholder="輸入勇者名稱" 
                       style="padding: 15px; width: 80%; border-radius: 10px; border: 2px solid var(--neon-cyan); background: rgba(0,0,0,0.5); color: white; font-size: 1.1em; font-family: 'Rajdhani', sans-serif;">
            </div>

            <p style="color: var(--text-secondary);">選擇執行模式：</p>
            <div class="mode-selector">
                <div class="mode-option active" onclick="selectMode('web')" id="modeWeb">
                    <i class="fas fa-globe"></i>
                    <div>網頁版</div>
                    <small style="font-size:0.75em; color:#aaa;">瀏覽器遊玩</small>
                </div>
                <div class="mode-option" onclick="selectMode('pygame')" id="modePygame">
                    <i class="fas fa-desktop"></i>
                    <div>Pygame版</div>
                    <small style="font-size:0.75em; color:#aaa;">本地視窗</small>
                </div>
            </div>

            <button class="tech-btn" onclick="startGame()">
                <i class="fas fa-check"></i> 確認設定
            </button>
        </div>
    </div>

    <!-- 戰鬥回放模態框 -->
    <div id="replayModal" class="modal-tech">
        <div class="modal-content-tech" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-play-circle"></i> 戰鬥回放</h3>
                <button class="close-btn-tech">&times;</button>
            </div>
            <div id="replayLog" class="replay-content"></div>
        </div>
    </div>

    <!-- 玩法說明模態框 -->
    <div id="helpModal" class="modal-tech">
        <div class="modal-content-tech help-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-open"></i> 遊戲玩法說明</h3>
                <button class="close-btn-tech" id="closeHelpModal">&times;</button>
            </div>
            
            <div class="help-content" style="padding: 20px;">
                <div class="help-section">
                    <h4><i class="fas fa-gamepad"></i> 遊戲模式</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        回合制戰鬥遊戲，扮演<strong style="color: var(--person-color);">勇者</strong>挑戰<strong style="color: var(--dragon-color);">龍王</strong>！
                    </p>
                    <div class="mode-comparison">
                        <div class="mode-card manual">
                            <h5><i class="fas fa-hand-pointer"></i> 手動模式</h5>
                            <p>親自操控，選擇技能</p>
                        </div>
                        <div class="mode-card auto">
                            <h5><i class="fas fa-robot"></i> 自動模式</h5>
                            <p>AI 自動戰鬥</p>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h4><i class="fas fa-magic"></i> 勇者技能</h4>
                    <div class="skill-list">
                        <div class="skill-item">
                            <div class="skill-key">1</div>
                            <div class="skill-info">
                                <div class="skill-name">光之斬擊（普攻）</div>
                                <div class="skill-desc">基礎攻擊，有機率暴擊</div>
                            </div>
                            <div class="skill-stats">
                                <span class="skill-damage">傷害: 2 (暴擊: 4)</span>
                                <span class="skill-cd">冷卻: 無</span>
                            </div>
                        </div>
                        <div class="skill-item">
                            <div class="skill-key">2</div>
                            <div class="skill-info">
                                <div class="skill-name">治癒</div>
                                <div class="skill-desc">恢復生命值</div>
                            </div>
                            <div class="skill-stats">
                                <span class="skill-heal">治療: +4 HP</span>
                                <span class="skill-cd">冷卻: 2 回合</span>
                            </div>
                        </div>
                        <div class="skill-item">
                            <div class="skill-key">3</div>
                            <div class="skill-info">
                                <div class="skill-name">勝利之斬（大絕）</div>
                                <div class="skill-desc">強力一擊！</div>
                            </div>
                            <div class="skill-stats">
                                <span class="skill-damage">傷害: 5 (暴擊: 10)</span>
                                <span class="skill-cd">冷卻: 5 回合</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tip-box">
                    <h5><i class="fas fa-lightbulb"></i> 戰術提示</h5>
                    <ul>
                        <li>大絕開場風險高，建議先消耗龍王血量</li>
                        <li>血量低於 8 時考慮治療</li>
                        <li>注意技能冷卻時間</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="../static/js/config.js"></script>
    <script src="../static/js/ui.js"></script>
    <script src="../static/js/player.js"></script>
    <script src="../static/js/api.js"></script>
    <script src="../static/js/game.js"></script>
    <script src="../static/js/handlers.js"></script>
    <script src="../static/js/helper.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initPlayerName();
            new ParticleSystem();
            setupEventHandlers();
            setupHelpModal();
            setupDifficultySelector();
            loadStats();
            loadCharacterStats();
            loadRecentGames();
            initWebSocket();
        });
    </script>
</body>
</html>
